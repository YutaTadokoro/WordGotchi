# WordGotchi

WordGotchiは、言葉を食べて成長する仮想ペットアプリケーションです。感情分析とAI生成アートを組み合わせた、インタラクティブな体験を提供します。

## 機能

- 📝 **インタラクティブな言葉の餌やり**: 入力したテキストが個別の単語に分解され、クリックしてGotchiに食べさせることができます
- � **感情分析**: Claude APIを使用して7つの基本感情（喜び、悲しみ、怒り、恐れ、驚き、嫌悪、信頼）を分析
- 🎨 **感情ベースのアート生成**: Google Gemini Imagen APIを使用して、蓄積された感情から抽象アートを生成
- � **詩の進生成**: 入力テキストと感情状態から詩を自動生成
- � **2段階の進化システム**: 
- ✨ **リッチなアニメーション**: 
  - 単語が飛んでいくベジェ曲線の軌跡
  - Gotchiの浮遊アニメーション
  - 感情に応じたエモートアニメーション
  - 進化時の特殊エフェクト
- 🌈 **感情グロー効果**: 支配的な感情に応じてGotchiの周りに色付きのグローが表示されます

## セットアップ

### 1. 依存関係のインストール

```bash
npm install
```

### 2. 環境変数の設定

`.env.example`を`.env`にコピーして、必要なAPIキーを設定してください：

```bash
cp .env.example .env
```

#### Claude API設定

感情分析にはClaude APIを使用します。以下のいずれかの方法で設定できます：

プロキシサーバー経由で使用します：

```env
VITE_CLAUDE_PROXY_TARGET=http://127.0.0.1:8000
```

**プロキシサーバーの役割：**
- Claude APIキーの管理
- 認証ヘッダーの追加
- APIエンドポイントの構築

**注意**: Claude APIキーはプロキシサーバー側で管理されます。フロントエンドには直接APIキーを含めないでください。

#### Gemini API設定

アート生成にはGoogle Gemini Imagen APIを使用します。プロキシサーバー経由で使用します：

```env
VITE_GEMINI_PROXY_TARGET=http://127.0.0.1:8001
```

**プロキシサーバーの役割：**
- Gemini APIキーの管理
- Google Cloud Project IDの管理
- 認証ヘッダーの追加
- APIエンドポイントの構築

**プロキシサーバーの実装例：**

プロキシサーバーは以下のエンドポイントを提供する必要があります：
- `POST /generate` - 画像生成リクエストを受け取り、Gemini Imagen APIに転送

プロキシサーバー側で以下を設定してください：
1. Gemini APIキー
2. Google Cloud Project ID
3. リクエストを `https://us-central1-aiplatform.googleapis.com/v1/projects/{PROJECT_ID}/locations/us-central1/publishers/google/models/imagen-3.0-generate-001:predict` に転送

詳細な実装例は `proxy-server-example.md` を参照してください。

### 3. 開発サーバーの起動

```bash
npm run dev
```

ブラウザで `http://localhost:5173` を開いてください。

### 4. ビルド

```bash
npm run build
```

## 使い方

1. **テキスト入力**: テキストボックスに言葉を入力（最大500文字）
2. **単語の散布**: 送信すると、入力テキストが個別の単語に分解され、キャンバスエリアに散らばります
3. **餌やり**: 散らばった単語をクリックすると、Gotchiに向かって飛んでいきます
4. **感情分析**: Gotchiが単語を食べると、感情が分析され、蓄積されます
5. **エモート**: すべての単語を食べ終わると、感情に応じたエモートアニメーションが再生されます
6. **進化**: 10回餌を与えると、特殊な進化アニメーションとともにGotchiがStage 2に進化します
7. **表現生成**: Stage 2以降は、餌やりのたびに感情に基づいたアートと詩が自動生成されます
8. **作品の保存**: 生成されたアートや詩はダウンロード・保存できます

### 感情システム

- **7つの基本感情**: 喜び、悲しみ、怒り、恐れ、驚き、嫌悪、信頼
- **感情の蓄積**: 餌やりのたびに感情が蓄積されます
- **感情の減衰**: 時間経過とともに感情が徐々に薄れます（1日あたり5%）
- **グロー効果**: 支配的な感情に応じてGotchiの周りに色付きのグローが表示されます

### データ管理

- **自動保存**: すべての状態変更が自動的にローカルストレージに保存されます
- **エクスポート**: GotchiのデータをJSON形式でエクスポートできます
- **インポート**: 他のブラウザやデバイスからデータをインポートできます
- **容量管理**: ストレージが5MBを超えると、古いデータが自動的に削除されます

## 技術スタック

- **フロントエンド**: React 19 + TypeScript + Vite
- **スタイリング**: CSS
- **アニメーション**: 
  - Framer Motion (UIアニメーション)
  - Konva + React Konva (キャンバスアニメーション)
- **AI API**: 
  - Claude API (感情分析・詩生成)
  - Google Gemini Imagen API (画像生成)
- **ストレージ**: LocalStorage
- **テスト**: 
  - Vitest (ユニットテスト・統合テスト)
  - fast-check (プロパティベーステスト)
  - Testing Library (コンポーネントテスト)

## プロジェクト構造

```
src/
├── components/     # UIコンポーネント
│   ├── Canvas.tsx              # メインキャンバスエリア
│   ├── GotchiCharacter.tsx     # Gotchiキャラクター
│   ├── Input.tsx               # テキスト入力コンポーネント
│   ├── Popup.tsx               # アート・詩表示ポップアップ
│   ├── EvolutionAnimation.tsx  # 進化アニメーション
│   ├── GlowEffect.tsx          # 感情グローエフェクト
│   ├── ScatteredWord.tsx       # 散らばる単語
│   └── ...
├── contexts/       # React Context
│   └── GotchiContext.tsx       # グローバル状態管理
├── services/       # APIクライアントとビジネスロジック
│   ├── ClaudeAPIClient.ts      # Claude API統合
│   ├── GeminiClient.ts         # Gemini Imagen API統合
│   ├── ExpressionService.ts    # アート・詩生成サービス
│   ├── StorageService.ts       # ローカルストレージ管理
│   ├── AnimationController.ts  # アニメーション制御
│   └── SoundService.ts         # サウンド管理
├── types/          # TypeScript型定義
│   └── index.ts                # 共通型定義
├── utils/          # ユーティリティ関数
└── integration/    # 統合テスト
```

## テスト

### テストの実行

```bash
# すべてのテストを実行
npm test

# ウォッチモードでテストを実行
npm run test:watch

# カバレッジレポートを生成
npm run test -- --coverage
```

### テスト戦略

- **ユニットテスト**: 個別のコンポーネントとサービスの動作を検証
- **プロパティベーステスト**: fast-checkを使用して、100回以上のランダム入力で普遍的な性質を検証
- **統合テスト**: エンドツーエンドのワークフロー（餌やり、進化、データ永続化など）を検証
- **コンポーネントテスト**: Testing Libraryを使用してUIコンポーネントの動作を検証

### テストカバレッジ目標

- ユニットテストカバレッジ: >80%
- プロパティテスト: 27の正確性プロパティすべてが100回以上のイテレーションで合格
- 統合テスト: すべての重要なワークフローが合格

## 開発

### コードの品質

```bash
# リントチェック
npm run lint

# ビルドチェック
npm run build
```

### アーキテクチャ

WordGotchiは以下のレイヤーで構成されています：

1. **プレゼンテーション層**: React コンポーネント（Canvas、Input、Popup）
2. **状態管理層**: React Context によるグローバル状態管理
3. **サービス層**: ビジネスロジックと外部API統合
4. **ストレージ層**: LocalStorageによるデータ永続化

詳細な設計については、`.kiro/specs/wordgotchi/design.md` を参照してください。

## トラブルシューティング

### APIエラー

- **Claude API**: ネットワークエラーの場合、最大3回まで指数バックオフで再試行されます
- **Gemini Imagen API**: 生成エラーの場合、ユーザーに再試行オプションが表示されます（タイムアウト: 60秒）

### プロキシサーバーの設定

両方のAPIはプロキシサーバー経由で動作します。これにより：
- APIキーをフロントエンドに露出させない
- CORS問題を回避
- 認証とリクエストの一元管理

プロキシサーバーの実装例については、`proxy-server-example.md` を参照してください。

### ストレージエラー

- **容量超過**: 自動的に古いデータの20%が削除され、操作が再試行されます
- **破損データ**: 破損したキーがクリアされ、デフォルト値で初期化されます

### パフォーマンス

- アニメーションのフレームレートが30fps未満になると、自動的に複雑さが軽減されます

## ライセンス

MIT
